include:
- template: Security/SAST.gitlab-ci.yml

image: python:3.6

stages:
  - coverage
  - test
  - security
  - release

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_CACHE_DIR: "off"

coverage:
  image: python:3.6
  stage: coverage
  script:
    - pip install --upgrade pip
    - pip install -e .[dev]
    - python -m pytest --cov-fail-under=100 --cov=src --cov-report=xml --cov-report=term-missing || { echo "Tests failed. Exiting ..." && exit 1; }
  rules:
    - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf|test|misc|style|v\d+\.\d+\.\d+)/i'
      when: always
    - when: never
  coverage: /(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: "coverage.xml"
  allow_failure: false


# test_py36:
#   image: python:3.6
#   stage: test
#   script:
#     - pip install --upgrade pip
#     - pip install tox pytest-randomly
#     - tox --develop
#   rules:
#     - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf|test|chore|style)/i'
#       when: always
#     - when: never
#   allow_failure: false


# test_py37:
#   image: python:3.7
#   stage: test
#   script:
#     - pip install --upgrade pip
#     - pip install tox pytest-randomly
#     - tox --develop
#   rules:
#     - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf|test|chore|style)/i'
#       when: always
#     - when: never
#   allow_failure: false


# test_py38:
#   image: python:3.8
#   stage: test
#   script:
#     - pip install --upgrade pip
#     - pip install tox pytest-randomly
#     - tox --develop
#   rules:
#     - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf|test|chore|style)/i'
#       when: always
#     - when: never
#   allow_failure: false


# test_py39:
#   image: python:3.9
#   stage: test
#   script:
#     - pip install --upgrade pip
#     - pip install tox pytest-randomly
#     - tox --develop
#   rules:
#     - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf|test|chore|style)/i'
#       when: always
#     - when: never
#   allow_failure: false


# test_py310:
#   image: python:3.10
#   stage: test
#   script:
#     - pip install --upgrade pip
#     - pip install tox pytest-randomly
#     - tox --develop
#   rules:
#     - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf|test|chore|style)/i'
#       when: always
#     - when: never
#   allow_failure: false


# test_py311:
#   image: python:3.11
#   stage: test
#   script:
#     - pip install --upgrade pip
#     - pip install tox pytest-randomly
#     - tox --develop
#   rules:
#     - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf|test|chore|style)/i'
#       when: always
#     - when: never
#   allow_failure: false

# security:
#   stage: security
#   script:
#     - pip install bandit
#     - bandit -r **/katalytic
#   rules:
#     - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf|test|chore|style)/i'
#       when: always
#     - when: never
#   allow_failure: false

# sast:
#   stage: security
#   allow_failure: false

# release:
#   stage: release
#   script:
#     - source scripts/release.sh
  # rules:
  #   - if: '$CI_COMMIT_MESSAGE =~ /(feat|fix|refactor|perf)/i'
  #     when: always
  #   - when: never
#   only:
#     - main
