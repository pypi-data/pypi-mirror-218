"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_views_issueDetails_groupMerged_index_tsx"],{"./app/stores/groupingStore.tsx":(e,t,s)=>{s.d(t,{Z:()=>m}),s("../node_modules/core-js/modules/es.array.push.js"),s("../node_modules/core-js/modules/es.error.cause.js");var r=s("../node_modules/lodash/pick.js"),i=s.n(r),n=s("../node_modules/reflux/src/index.js"),o=s("./app/actionCreators/group.tsx"),a=s("./app/actionCreators/indicator.tsx"),l=s("./app/api.tsx"),g=s("./app/utils/toArray.tsx");const d={api:new l.KU,init(){const e=this.getInitialState();Object.entries(e).forEach((e=>{let[t,s]=e;this[t]=s}))},getInitialState:()=>({mergedItems:[],unmergeList:new Map,unmergeState:new Map,unmergeDisabled:!0,unmergeLastCollapsed:!1,enableFingerprintCompare:!1,similarItems:[],filteredSimilarItems:[],similarLinks:"",mergeState:new Map,mergeList:[],mergedLinks:"",mergeDisabled:!1,loading:!0,error:!1}),setStateForId:(e,t,s)=>(0,g.Z)(t).map((t=>{const r={...e.has(t)&&e.get(t)||{},...s};return e.set(t,r),r})),isAllUnmergedSelected(){const e=Array.from(this.unmergeState.values()).filter((e=>{let{busy:t}=e;return t}))||[];return this.unmergeList.size===this.mergedItems.filter((e=>{let{latestEvent:t}=e;return!!t})).length-e.length},onFetch(e){const t=e||this.toFetchArray;this.init(),this.triggerFetchState();const s=t.map((e=>{let{endpoint:t,queryParams:s,dataKey:r}=e;return new Promise(((e,i)=>{this.api.request(t,{method:"GET",data:s,success:(t,s,i)=>{e({dataKey:r,data:t,links:i?i.getResponseHeader("Link"):null})},error:e=>{const t=e.responseJSON?.detail||!0;i(t)}})}))})),r={merged:e=>{const t={},s=[];return e.forEach((e=>{if(!t[e.id]){const r={eventCount:0,children:[],...e};this.setStateForId(this.unmergeState,e.id,{busy:"locked"===e.state}),t[e.id]=r,s.push(r)}const r=t[e.id],{childId:i,childLabel:n,eventCount:o,lastSeen:a,latestEvent:l}=e;o&&(r.eventCount+=o),i&&r.children.push({childId:i,childLabel:n,lastSeen:a,latestEvent:l,eventCount:o})})),s},similar:e=>{let[t,s]=e;const r=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return!Object.keys(e).map((t=>e[t])).find((e=>e>=.6))}(s),i=Object.keys(s).map((e=>[e,s[e]])).reduce(((e,t)=>{let[s,r]=t;const[i]=String(s).split(":");return e[i]||(e[i]=[]),e[i].push([s,r]),e}),{}),n=Object.keys(i).map((e=>[e,i[e]])).reduce(((e,t)=>{let[s,r]=t;const i=r.filter((e=>{let[,t]=e;return null!==t})),n=i.reduce(((e,t)=>{let[,s]=t;return e+s}),0)/i.length;return e[s]=n,e}),{});return{issue:t,score:s,scoresByInterface:i,aggregate:n,isBelowThreshold:r}}};return e&&(this.toFetchArray=e),Promise.all(s).then((e=>{e.forEach((e=>{let{dataKey:t,data:s,links:i}=e;const n="similar"===t?s.map(r[t]):r[t](s);this[`${t}Items`]=n,this[`${t}Links`]=i})),this.loading=!1,this.error=!1,this.triggerFetchState()}),(()=>{this.loading=!1,this.error=!0,this.triggerFetchState()}))},onToggleMerge(e){let t=!1;const s=this.mergeState.has(e)?this.mergeState.get(e):void 0;!0!==s?.busy&&(this.mergeList.includes(e)?this.mergeList=this.mergeList.filter((t=>t!==e)):(this.mergeList=[...this.mergeList,e],t=!0),this.setStateForId(this.mergeState,e,{checked:t}),this.triggerMergeState())},onToggleUnmerge(e){let[t,s]=e,r=!1;const i=this.unmergeState.get(t);!0!==i?.busy&&(this.unmergeList.has(t)?this.unmergeList.delete(t):(this.unmergeList.set(t,s),r=!0),this.setStateForId(this.unmergeState,t,{checked:r}),this.unmergeDisabled=this.mergedItems.size<=1||0===this.unmergeList.size||this.isAllUnmergedSelected(),this.enableFingerprintCompare=2===this.unmergeList.size,this.triggerUnmergeState())},onUnmerge(e){let{groupId:t,loadingMessage:s,successMessage:r,errorMessage:i}=e;const n=Array.from(this.unmergeList.keys());return new Promise(((e,o)=>{this.isAllUnmergedSelected()?o(new Error("Not allowed to unmerge ALL events")):(this.unmergeDisabled=!0,this.setStateForId(this.unmergeState,n,{checked:!1,busy:!0}),this.triggerUnmergeState(),(0,a.E3)(s),this.api.request(`/issues/${t}/hashes/`,{method:"DELETE",query:{id:n},success:()=>{(0,a.S9)(r),this.setStateForId(this.unmergeState,n,{checked:!1,busy:!0}),this.unmergeList.clear()},error:()=>{(0,a.Iw)(i),this.setStateForId(this.unmergeState,n,{checked:!0,busy:!1})},complete:()=>{this.unmergeDisabled=!1,e(this.triggerUnmergeState())}}))}))},onMerge(e){let{params:t,query:s,projectId:r}=e;if(!t)return;const i=this.mergeList;return this.mergeDisabled=!0,this.setStateForId(this.mergeState,i,{busy:!0}),this.triggerMergeState(),new Promise((e=>{const{orgId:n,groupId:a}=t;(0,o.fr)(this.api,{orgId:n,projectId:r,itemIds:[...i,a],query:s},{success:e=>{e?.merge?.parent&&this.trigger({mergedParent:e.merge.parent}),this.setStateForId(this.mergeState,i,{checked:!1,busy:!0}),this.mergeList=[]},error:()=>{this.setStateForId(this.mergeState,i,{checked:!0,busy:!1})},complete:()=>{this.mergeDisabled=!1,e(this.triggerMergeState())}})}))},onToggleCollapseFingerprints(){this.setStateForId(this.unmergeState,this.mergedItems.map((e=>{let{id:t}=e;return t})),{collapsed:!this.unmergeLastCollapsed}),this.unmergeLastCollapsed=!this.unmergeLastCollapsed,this.trigger({unmergeLastCollapsed:this.unmergeLastCollapsed,unmergeState:this.unmergeState})},onToggleCollapseFingerprint(e){const t=this.unmergeState.has(e)&&this.unmergeState.get(e).collapsed;this.setStateForId(this.unmergeState,e,{collapsed:!t}),this.trigger({unmergeState:this.unmergeState})},triggerFetchState(){const e={similarItems:this.similarItems.filter((e=>{let{isBelowThreshold:t}=e;return!t})),filteredSimilarItems:this.similarItems.filter((e=>{let{isBelowThreshold:t}=e;return t})),...i()(this,["mergedItems","mergedLinks","similarLinks","mergeState","unmergeState","loading","error","enableFingerprintCompare","unmergeList"])};return this.trigger(e),e},triggerUnmergeState(){const e=i()(this,["unmergeDisabled","unmergeState","unmergeList","enableFingerprintCompare","unmergeLastCollapsed"]);return this.trigger(e),e},triggerMergeState(){const e=i()(this,["mergeDisabled","mergeState","mergeList"]);return this.trigger(e),e},getState(){return{...i()(this,["enableFingerprintCompare","error","filteredSimilarItems","loading","mergeDisabled","mergeList","mergeState","mergeState","mergedItems","mergedLinks","similarItems","similarLinks","unmergeDisabled","unmergeLastCollapsed","unmergeList","unmergeState"])}}},m=(0,n.createStore)(d)},"./app/views/issueDetails/groupMerged/index.tsx":(e,t,s)=>{s.r(t),s.d(t,{GroupMergedView:()=>X,default:()=>G});var r=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),i=s("../node_modules/react/index.js"),n=s("../node_modules/query-string/index.js"),o=s("./app/components/alert.tsx"),a=s("./app/components/layouts/thirds.tsx"),l=s("./app/components/loadingError.tsx"),g=s("./app/components/loadingIndicator.tsx"),d=s("./app/locale.tsx"),m=s("./app/stores/groupingStore.tsx"),h=s("./app/utils/analytics.tsx"),p=s("./app/utils/withOrganization.tsx"),u=s("./app/components/emptyStateWarning.tsx"),c=s("./app/components/pagination.tsx"),b=s("./app/components/panels/index.tsx"),y=s("./app/components/queryCount.tsx"),S=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),Z=s("./app/components/checkbox.tsx"),f=s("./app/components/eventOrGroupHeader.tsx"),I=s("./app/components/tooltip.tsx"),v=s("./app/icons/index.tsx"),L=s("./app/styles/space.tsx"),k=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class x extends i.Component{constructor(){super(...arguments),(0,r.Z)(this,"state",{collapsed:!1,checked:!1,busy:!1}),(0,r.Z)(this,"listener",m.Z.listen((e=>this.onGroupChange(e)),void 0)),(0,r.Z)(this,"onGroupChange",(e=>{let{unmergeState:t}=e;if(!t)return;const{fingerprint:s}=this.props,r=t.has(s.id)?t.get(s.id):void 0;r&&Object.keys(r).forEach((e=>{r[e]!==this.state[e]&&this.setState((t=>({...t,[e]:r[e]})))}))})),(0,r.Z)(this,"handleToggleEvents",(()=>{const{fingerprint:e}=this.props;m.Z.onToggleCollapseFingerprint(e.id)})),(0,r.Z)(this,"handleToggle",(()=>{const{fingerprint:e}=this.props,{latestEvent:t}=e;this.state.busy||m.Z.onToggleUnmerge([e.id,t.id])}))}handleLabelClick(e){e.preventDefault()}handleCheckClick(){}renderFingerprint(e,t){return t?(0,k.tZ)(I.u,{title:e,children:(0,k.tZ)("code",{children:t})}):e}render(){const{fingerprint:e,organization:t,totalFingerprint:s}=this.props,{latestEvent:r,id:i,label:n}=e,{collapsed:o,busy:a,checked:l}=this.state,g=a||1===s;return(0,k.BX)(C,{busy:a,children:[(0,k.BX)(j,{expanded:!o,children:[(0,k.BX)(F,{onClick:this.handleToggle,children:[(0,k.tZ)(I.u,{disabled:!g,title:g&&1===s?(0,d.t)("To check, the list must contain 2 or more items"):void 0,children:(0,k.tZ)(Z.Z,{id:i,value:i,checked:l,disabled:g,onChange:this.handleCheckClick})}),(0,k.tZ)(w,{onClick:this.handleLabelClick,htmlFor:i,children:this.renderFingerprint(i,n)})]}),(0,k.tZ)("div",{children:(0,k.tZ)(T,{onClick:this.handleToggleEvents,children:(0,k.tZ)(v.g6,{direction:o?"down":"up",size:"xs"})})})]}),!o&&(0,k.tZ)(D,{className:"event-list",children:r&&(0,k.tZ)(E,{className:"event-details",children:(0,k.tZ)(f.Z,{data:r,organization:t,hideIcons:!0,hideLevel:!0,source:"merged-item"})})})]})}}x.displayName="MergedItem";const C=(0,S.Z)("div",{target:"e17l9jug6"})((e=>e.busy&&"opacity: 0.2"),";"),F=(0,S.Z)("div",{target:"e17l9jug5"})("display:grid;grid-auto-flow:column;align-items:center;gap:",(0,L.D)(1),";"),j=(0,S.Z)("div",{target:"e17l9jug4"})("display:flex;justify-content:space-between;border-top:1px solid ",(e=>e.theme.innerBorder),";background-color:",(e=>e.theme.backgroundSecondary),";padding:",(0,L.D)(.5)," ",(0,L.D)(1),";",(e=>e.expanded&&`border-bottom: 1px solid ${e.theme.innerBorder}`),";",C,"{&:first-child &{border-top:none;}&:last-child &{border-top:none;border-bottom:1px solid ",(e=>e.theme.innerBorder),";}}"),w=(0,S.Z)("label",{target:"e17l9jug3"})("font-family:",(e=>e.theme.text.familyMono),";",j," &{font-weight:400;margin:0;}"),T=(0,S.Z)("span",{target:"e17l9jug2"})({name:"e0dnmk",styles:"cursor:pointer"}),D=(0,S.Z)("div",{target:"e17l9jug1"})("overflow:hidden;border:none;background-color:",(e=>e.theme.background),";"),E=(0,S.Z)("div",{target:"e17l9jug0"})("display:flex;justify-content:space-between;.event-list &{padding:",(0,L.D)(1),";}"),M=x;var U=s("./app/actionCreators/modal.tsx"),_=s("./app/components/button.tsx"),q=s("./app/components/confirm.tsx"),z=s("./app/stores/useLegacyStore.tsx");function B(e){let{groupId:t,project:s,orgId:r,onUnmerge:i,onToggleCollapse:n}=e;const{unmergeList:o,mergedItems:a,unmergeLastCollapsed:l,unmergeDisabled:g,enableFingerprintCompare:h}=(0,z.X)(m.Z),p=o?.size??0,u=a.length<=1?(0,d.t)("To unmerge, the list must contain 2 or more items"):0===o.size?(0,d.t)("To unmerge, 1 or more items must be selected"):m.Z.isAllUnmergedSelected()?(0,d.t)("We are unable to unmerge all items at once"):void 0;return(0,k.BX)(b.V9,{hasButtons:!0,children:[(0,k.BX)("div",{children:[(0,k.tZ)(q.Z,{disabled:g,onConfirm:i,message:(0,d.t)("These events will be unmerged and grouped into a new issue. Are you sure you want to unmerge these events?"),children:(0,k.tZ)(_.zx,{size:"sm",title:u,children:a.length<=1?(0,d.t)("Unmerge"):(0,d._N)("Unmerge ([itemsSelectedQuantity])",{itemsSelectedQuantity:p})})}),(0,k.tZ)(A,{size:"sm",disabled:!h,onClick:function(e){e.stopPropagation();const i=o.entries();if(2!==o.size)return;const[n,a]=Array.from(i).map((e=>{let[,t]=e;return t}));(0,U.openDiffModal)({targetIssueId:t,project:s,baseIssueId:t,orgId:r,baseEventId:n,targetEventId:a})},title:h?void 0:(0,d.t)("To compare, exactly 2 items must be selected"),children:(0,d.t)("Compare")})]}),(0,k.tZ)(_.zx,{size:"sm",onClick:n,children:l?(0,d.t)("Expand All"):(0,d.t)("Collapse All")})]})}B.displayName="MergedToolbar";const A=(0,S.Z)(_.zx,{target:"euprq3o0"})("margin-left:",(0,L.D)(1),";");function N(e){let{fingerprints:t=[],pageLinks:s,onToggleCollapse:r,onUnmerge:n,organization:o,groupId:a,project:l}=e;const g=t.filter((e=>{let{latestEvent:t}=e;return!!t}));return g.length>0?(0,k.BX)(i.Fragment,{children:[(0,k.BX)("h4",{children:[(0,k.tZ)("span",{children:(0,d.t)("Merged fingerprints with latest event")})," ",(0,k.tZ)(y.Z,{count:g.length})]}),(0,k.BX)(b.s_,{children:[(0,k.tZ)(B,{onToggleCollapse:r,onUnmerge:n,orgId:o.slug,project:l,groupId:a}),(0,k.tZ)(b.N,{children:g.map((e=>(0,k.tZ)(M,{organization:o,fingerprint:e,totalFingerprint:g.length},e.id)))})]}),s&&(0,k.tZ)(c.Z,{pageLinks:s})]}):(0,k.tZ)(b.s_,{children:(0,k.tZ)(u.Z,{children:(0,k.tZ)("p",{children:(0,d.t)("There don't seem to be any hashes for this issue.")})})})}N.displayName="MergedList";const P=(0,p.Z)(N);class X extends i.Component{constructor(){super(...arguments),(0,r.Z)(this,"state",{mergedItems:[],loading:!0,error:!1,query:this.props.location.query.query||""}),(0,r.Z)(this,"onGroupingChange",(e=>{let{mergedItems:t,mergedLinks:s,loading:r,error:i}=e;t&&this.setState({mergedItems:t,mergedLinks:s,loading:void 0!==r&&r,error:void 0!==i&&i})})),(0,r.Z)(this,"listener",m.Z.listen(this.onGroupingChange,void 0)),(0,r.Z)(this,"fetchData",(()=>{m.Z.onFetch([{endpoint:this.getEndpoint(),dataKey:"merged",queryParams:this.props.location.query}])})),(0,r.Z)(this,"handleUnmerge",(()=>{m.Z.onUnmerge({groupId:this.props.params.groupId,loadingMessage:(0,d.t)("Unmerging eventsâ€¦"),successMessage:(0,d.t)("Events successfully queued for unmerging."),errorMessage:(0,d.t)("Unable to queue events for unmerging.")});const e=[...m.Z.getState().unmergeList.values()];(0,h.Gi)("issue_details.merged_tab.unmerge_clicked",{organization:this.props.organization,group_id:this.props.params.groupId,event_ids_unmerged:e.join(","),total_unmerged:e.length})}))}componentDidMount(){this.fetchData()}UNSAFE_componentWillReceiveProps(e){if(e.params.groupId!==this.props.params.groupId||e.location.search!==this.props.location.search){const t=e.location.query;this.setState({query:t.query},this.fetchData)}}componentWillUnmount(){this.listener?.()}getEndpoint(){const{params:e,location:t}=this.props,{groupId:s}=e,r={...t.query,limit:50,query:this.state.query};return`/issues/${s}/hashes/?${n.stringify(r)}`}render(){const{project:e,params:t}=this.props,{groupId:s}=t,{loading:r,error:i,mergedItems:n,mergedLinks:h}=this.state,p=i&&!r,u=!p&&!r;return(0,k.tZ)(a.uT,{children:(0,k.BX)(a.or,{fullWidth:!0,children:[(0,k.tZ)(o.bZ,{type:"warning",children:(0,d.t)("This is an experimental feature. Data may not be immediately available while we process unmerges.")}),r&&(0,k.tZ)(g.Z,{}),p&&(0,k.tZ)(l.Z,{message:(0,d.t)("Unable to load merged events, please try again later"),onRetry:this.fetchData}),u&&(0,k.tZ)(P,{project:e,fingerprints:n,pageLinks:h,groupId:s,onUnmerge:this.handleUnmerge,onToggleCollapse:m.Z.onToggleCollapseFingerprints})]})})}}X.displayName="GroupMergedView";const G=(0,p.Z)(X)}}]);
//# sourceMappingURL=../sourcemaps/app_views_issueDetails_groupMerged_index_tsx.e54d4d580fd3bdb5834664fef168ba2d.js.map