{% extends 'base.html' %}

{% block header %}
  <h1>{% block title %}{% trans %}Edit draft{% endtrans %}{% endblock %}</h1>
{% endblock %}

{% block content %}
  <div class="flex-align">
    {% block left_panel %}
      <form method="post" id="bill_info">
        <label for="client_id">{% trans %}Client{% endtrans %}</label>
        <select name="client_id" id="client_id">
          <option value="">{% trans %}Empty{% endtrans %}</option>
          {% for client in clients %}
            <option value="{{ client.id }}" {{ "selected" if bill.client_id == client.id }}>{{ client.label }}</option>
          {% endfor %}
        </select>

        <label for="date">{% trans %}Date{% endtrans %}</label>
        <input name="date" id="date" type="date"
          value="{{ request.form['date'] or bill.date.strftime("%Y-%m-%d") }}">

        <label for="recipient">{% trans %}Recipient{% endtrans %}</label>
        <textarea name="recipient" id="recipient" rows="6" title="{% trans %}Taken from customer address.{% endtrans %}"
          >{{ request.form['recipient'] or bill.recipient or '' }}</textarea>

        <label for="source">{% trans %}Source{% endtrans %}</label>
        <textarea name="source" id="source" rows="6" title="{% trans %}Taken from your user configuration.{% endtrans %}"
          >{{ request.form['source'] or bill.source or '' }}</textarea>

        <input type="submit" value="{% trans %}Save{% endtrans %}">
      </form>
    {% endblock %}

    <div class="marged">
      {% block bill_row_panel %}
        {% if bill_rows|length > 0 %}
          <table>
            <thead>
              <tr>
                <th>{% trans %}Label{% endtrans %}</th>
                <th>{% trans %}Price{% endtrans %}</th>
                <th>{% trans %}Qty{% endtrans %}</th>
                <th>{% trans %}Amount{% endtrans %}</th>
                <th>{% trans %}Tax{% endtrans %}</th>
                <th>{% trans %}Action{% endtrans %}</th>
              </tr>
            </thead>
            <tbody>
              {% for bill_row in bill_rows %}
                <tr>
                  <td id="bill_row_{{ bill_row.id }}">{{ bill_row.label }}</td>
                  <td>{{ bill_row.price/100 }}</td>
                  <td>{{ bill_row.quantity }}</td>
                  <td>{{ (bill_row.gross_amount / 100) | round(2, 'floor') }}</td>
                  <td>{{ bill_row.tax_rate }} %</td>
                  <td class="actions">
                    <a href="{{ url_for('bill.update', id=bill['id'], edit_bill_row_id=bill_row['id']) }}">{% trans %}Update{% endtrans %}</a>
                    <form action="{{ url_for('bill.delete_row', id=bill_row['id']) }}" method="post">
                      <input class="danger" type="submit" value="{% trans %}Delete{% endtrans %}" onclick="return confirm('{% trans %}Are you sure?{% endtrans %}');">
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% endif %}
        {% if edit_bill_row %}
          <form action="{{ url_for('bill.update_row', id=edit_bill_row['id']) }}" method="post">
            <label for="label">{% trans %}Label{% endtrans %}</label>
            <input name="label" id="label" value="{{ edit_bill_row.label }}" required autofocus>
            <label for="price">{% trans %}Price{% endtrans %}</label>
            <input name="price" id="price" type="number" step="0.01"" value="{{ edit_bill_row.price/100 }}" required>
            <label for="tax_rate">{% trans %}Tax rate{% endtrans %}</label>
            <input name="tax_rate" id="tax_rate" type="number" step="0.01" value="{{ edit_bill_row.tax_rate }}" max="100" min="0" required>
            <label for="quantity">{% trans %}Qty{% endtrans %}</label>
            <input name="quantity" id="quantity" type="number" value="{{ edit_bill_row.quantity }}" required>
            <div class="actions">
              <input type="submit" value="{% trans %}Save{% endtrans %}">
              <a href="{{ url_for('bill.update', id=bill['id']) }}">{% trans %}Cancel{% endtrans %}</a>
            </div>
          </form>
        {% endif %}
        <div class="flex-align">
          <form action="{{ url_for('bill.create_row', id=bill['id']) }}" method="post"
            title="{% trans %}Add a row from an existing product.{% endtrans %}">
            <label for="product_id">{% trans %}Product{% endtrans %}</label>
            <select name="product_id" id="product_id">
              {% for product in products %}
                <option value="{{ product.id }}">{{ product.label }} - {{ product.price/100 }}</option>
              {% endfor %}
            </select>
            <label for="quantity2">{% trans %}Quantity{% endtrans %}</label>
            <input name="quantity" id="quantity2" type="number" required>
            <input type="submit" value="{% trans %}Create row{% endtrans %}">
          </form>
          <form action="{{ url_for('bill.create_row', id=bill['id']) }}" method="post" class="marged"
            title="{% trans %}Add a row from scratch.{% endtrans %}">
            <label for="label">{% trans %}Label{% endtrans %}</label>
            <input name="label" id="label" required>
            <label for="price">{% trans %}Price{% endtrans %}</label>
            <input name="price" id="price" type="number" step="0.01" required>
            <label for="tax_rate">{% trans %}Tax rate{% endtrans %}</label>
            <input name="tax_rate" id="tax_rate" type="number" step="0.01" max="100" min="0" required>
            <label for="quantity">{% trans %}Quantity{% endtrans %}</label>
            <input name="quantity" id="quantity" type="number" required>
            <input type="submit" value="{% trans %}Create row{% endtrans %}">
          </form>
        </div>
      {% endblock %}
      <form action="{{ url_for('bill.update_comment', id=bill['id']) }}" id="bill_comment" method="post">
        <label for="comment">{% trans %}Comment{% endtrans %}</label>
        <textarea name="comment" id="comment" rows="5">{{ bill.comment or '' }}</textarea>
        <input type="submit" value="{% trans %}Save{% endtrans %}">
      </form>
    </div>
  </div>

  {% block mention_panel %}
    <form action="{{ url_for('bill.update_mentions', id=bill['id']) }}" id="bill_mentions" method="post">
      <label for="quote_mentions">{% trans %}Quote mentions{% endtrans %}</label>
      <textarea name="quote_mentions" id="quote_mentions" rows="5"
         title="{% trans %}Taken from your user configuration.{% endtrans %}"
        >{{ bill.quote_mentions or '' }}</textarea>
      <label for="bill_mentions">{% trans %}Bill mentions{% endtrans %}</label>
      <textarea name="bill_mentions" id="bill_mentions" rows="5"
         title="{% trans %}Taken from your user configuration.{% endtrans %}"
        >{{ bill.bill_mentions or '' }}</textarea>
      <input type="submit" value="{% trans %}Save{% endtrans %}">
    </form>
  {% endblock %}

  <hr>

  {% block actions %}
    <div class="actions">
      <a href="{{ url_for('bill.view_quote_pdf', id=bill['id']) }}">{% trans %}Preview quote{% endtrans %}</a>
      <form action="{{ url_for('bill.create_quote', id=bill['id']) }}" method="post">
        <input type="submit" value="{% trans %}Create quote{% endtrans %}" onclick="return confirm('{% trans %}Are you sure?{% endtrans %}');">
      </form>
      <form action="{{ url_for('bill.create_bill', id=bill['id']) }}" method="post">
        <input type="submit" value="{% trans %}Create bill{% endtrans %}" onclick="return confirm('{% trans %}Are you sure?{% endtrans %}');">
      </form>
      <form action="{{ url_for('bill.delete', id=bill['id']) }}" method="post">
        <input class="danger" type="submit" value="{% trans %}Delete{% endtrans %}" onclick="return confirm('{% trans %}Are you sure?{% endtrans %}');">
      </form>
    </div>
  {% endblock %}
{% endblock %}
